<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml">
<head>
    <title>Bug Tracker</title>
    <script src="https://ajax.googleapis.com/ajax/libs/angularjs/1.6.4/angular.min.js"></script>
    <!--

    Use Case
    --------------

    1. Add a bug -done
    2. list all the bugs - done
    3. toggle the completion status of the bug - done
    4. Remove closed bugs. - done
    5. Display statistics. - done.
    6. Search for bugs -- done.
    7. Sort the bugs -- done
    8. improvies how the bugs are displayed
    9. persist the bugs in the storage
    window.localStorage
        - key/value store
        - both key and value should be strings
        - apis
        . setItem(key,value)
        . getItem(key) //= > value
        . removeItem(key)
        . key(index)
        . clear()
        . length
        10. display the createdDT of the bugs
        11 persis the bugs in the server
        12 categorize the bugs
        13 view the bugs belong to one particular category
        -->

    <script>

        var bugTrackerApp = angular.module("bugTrackerApp", []);
        bugTrackerApp.run(function ($rootScope) {
        });

        bugTrackerApp.value('defaultTrimLength', 20);

        bugTrackerApp.factory("Bug", function () {
            function Bug(defaults) {
                defaults = defaults || {};
                this.name = defaults.name || "";
                this.isClosed = defaults.isClosed || false;
            }

            Bug.prototype.toggle = function () {
                this.isClosed = !this.isClosed;
            };
            return Bug;
        });

        bugTrackerApp.filter('trimText', function (defaultTrimLength) {
            return function (data, length) {
                length = length || defaultTrimLength;
                return data.length > length ? data.substr(0, length) + '...' : data;
            }
        });

        bugTrackerApp.factory('BugStorage', function ($window, Bug) {

            var storage = $window.localStorage;
            var maxBugId = 0;
            function save(bug) {
                bug.id = bug.id || ++maxBugId;
                storage.setItem(bug.id, angular.toJson(bug));
                return bug;
            }

            function getAll() {

                var bugs = [];
                for (var i = 0; i < storage.length; i++) {

                    var key = storage.key(i);
                    if (isNaN(key))
                        return bugs;

                    maxBugId = parseInt(key) > maxBugId ? parseInt(key) : maxBugId;

                    var bugAsString = storage.getItem(key);
                    var bugData = angular.fromJson(bugAsString);
                    var bug = new Bug(bugData);
                    bugs.push(bug);

                }
                return bugs;
            }

            function remove(bug) {

                storage.removeItem(bug.id);
            }
            return {
                getAll: getAll,
                save: save,
                remove: remove

            }

        });

        //bugTrackerApp.filter("closedCount", function () {

        //    return function (bugs) {
        //        return bugs.reduce(function (total, bug) {
        //            return bug.isClosed ? ++total : total;
        //        }, 0);
        //    }
        //});


        bugTrackerApp.filter("closedCount", function ($filter) {
            var builtInFilter = $filter('filter');
            return function (bugs) {

                return builtInFilter(bugs, { isClosed: true }).length;
            }
        });

        bugTrackerApp.controller("bugController", function (Bug, BugStorage) {
            //var bugs = [
            //  new Bug({ name: 'function is not defined' }),
            //  new Bug({ name: 'stack over flow exception' }),
            //   new Bug({ name: 'arthemtic exception' }),
            //   new Bug({ name: 'object reference not set to instance of an object' }),
            //   new Bug({ name: 'runtime server error occured ' })
            //];
            var bugs = BugStorage.getAll();
            this.bugs = bugs;
            this.name = "";

            this.add = function () {
                this.bugs.push(BugStorage.save(new Bug({ name: this.name })));
            }
            this.toggle = function (bug) {

                bug.toggle();
                BugStorage.save(bug);
            };
            this.removeClosedBugs = function () {
                for (var i = this.bugs.length - 1; i >= 0; i--) {
                    if (this.bugs[i].isClosed) {
                        BugStorage.remove(this.bugs[i]);
                        this.bugs.splice(i, 1);
                    }
                }
            }

            //this.getClosedBugs = function () {
            //    return this.bugs.reduce(function (total, bug) {
            //        return bug.isClosed ? ++total : total;
            //    }, 0);

            //}

        });


    </script>
    <style>
        .closed {
            color: red;
            font-weight: bold;
            font-style: italic;
            text-decoration: line-through;
        }

        .statistics, .search, .orderBy, .bugs {
            padding: 10px 0px;
        }
    </style>
</head>


<body ng-app="bugTrackerApp" ng-controller="bugController as bc">
    <h2> Bug Tracker </h2>
    <div class="statistics">{{ bc.bugs | closedCount}}/ {{bc.bugs.length}}   </div>

    <div class="search">
        Search : <input type="text" name="txtSearch" ng-model="filterBugs.name" value=" " /> <label>isClosed ? </label> <input type="checkbox" name="" ng-model="filterBugs.isClosed" id="" /> <input id="" type="button" value="Show All" ng-click="filterBugs.isClosed=undefined" />
    </div>

    <div class="orderBy">
        Order By : <input type="text" name="txtOrder" ng-model="orderBy" /> <label>isDecending</label> <input type="checkbox" name="" ng-model="isDescending" />
    </div>
    <div class="bugs">
        Bug Title:   <input type="text" name="txtBug" ng-model="bc.name" value=" " /> <input type="button" ng-click="bc.add()" value="AddBug" id="btnAddBug" /><input type="button" ng-click="bc.removeClosedBugs()" value="Remove Closed" id="btnRemoveBug" />
    </div>
    <div class="bugs">
        <ol>
            <li ng-repeat="bug in bc.bugs | filter:filterBugs | orderBy : orderBy : isDescending"
                ng-class="{closed : bug.isClosed}"
                ng-click="bc.toggle(bug)">{{bug.name | trimText :30 }}</li>
        </ol>
    </div>


</body>
</html>
